---
kind: pipeline
name: test

steps:
  - name: test
    image: alpine:3.12
    pull: always
    environment:
      CARGO_HOME: target/cargo
      RUST_BACKTRACE: 1
      RUST_LOG: debug
    commands:
      - apk add --no-cache cargo git
      - git log -n1
      - cargo -V
      - cargo test
  - name: notify
    image: plugins/matrix
    settings:
      homeserver: https://synapse.matrix.msrd0.de
      roomid: "SGqhOjASPrkaVyOdux:msrd0.de"
      username: drone
      password:
        from_secret: matrix_password
    when:
      status:
        - failure

---
kind: pipeline
name: rustfmt

steps:
  # DO NOT UPDATE TO ALPINE 3.14 - it uses known broken rustup
  - name: rustfmt
    image: alpine:3.13
    pull: always
    commands:
      - apk add rustup
      - rustup-init -qy --default-host x86_64-unknown-linux-musl --default-toolchain none </dev/null
      - source $CARGO_HOME/env
      - rustup toolchain install nightly --profile minimal --component rustfmt
      - cargo -V
      - cargo fmt -- -V
      - cargo fmt -- --check -l
  - name: notify
    image: plugins/matrix
    settings:
      homeserver: https://synapse.matrix.msrd0.de
      roomid: "SGqhOjASPrkaVyOdux:msrd0.de"
      username: drone
      password:
        from_secret: matrix_password
    when:
      status:
        - failure

environment:
  CARGO_HOME: target/cargo

---
kind: signature
hmac: 531bb4b513ce37a8c82b3b93ecf50ff708ed3c6d488beb3a8fdc9041369f7b01

...
